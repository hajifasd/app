# Course Stat Tool — 文件说明与已知问题

下面文档描述了仓库中主要文件的功能、工具已实现的功能点，以及我在代码中发现的缺陷与改进建议。所有内容为中文说明，便于维护者快速了解项目架构与短期改进方向。

## 目录

- `config.yaml`：字段匹配与输出路径配置
- `run.py`：命令行主程序入口（演示型）
- `gui_run.py`：带 GUI 的主要实现（解析、清洗、统计、导出）
- `requirements.txt`：依赖列表
- `src/__init__.py`：包初始化（占位）
- `src/file_parser.py`：解析 Excel / PDF 的实现（无界面）
- `src/data_cleaner.py`：数据清洗、去重与标准化逻辑
- `src/stat_export.py`：统计计算与导出为 Excel 的逻辑

---

## 各文件功能概述

- `config.yaml`
	- 功能：定义字段映射（多个可能列名对应的目标字段），以及默认的输出文件路径（`output.path`）。用于把不同格式/列名的表格统一映射到内部字段名。

- `run.py`
	- 功能：作为命令行示例入口，展示如何调用 `src` 包中的 `parse_files` -> `clean_courses` -> `stat_and_export` 的流程。
	- 注意：`INPUT_FOLDER` 为硬编码示例路径，使用前需修改为实际目录。

- `gui_run.py`
	- 功能：完整的 Tkinter GUI 应用，提供文件选择、解析日志、清洗、统计与导出功能。核心工作函数包括 `parse_single_file`、`clean_courses`、`stat_courses`、`export_excel`，以及 `CourseParserGUI` 类实现的界面交互。
	- 已实现的点：
		- 支持解析 Excel（逐 sheet）和表格型 PDF（使用 pdfplumber 的表格提取），并从单元格中抽取课程名、老师、时长、节次等信息。
		- 使用 `config.yaml` 匹配列名，提高对不同表头的兼容性。
		- 对 PDF 有“合并单元格/上行时间段回填”的策略（用上一个有效时间段填充空时间段），并通过正则从单元格文本抽取课程名、周次、地点和老师。
		- 清洗阶段做了去重、字段标准化（去特殊字符）、课程时长标准化为数值，并统计多种聚合指标（总课时、老师数量、分类分布等）。
		- 支持通过 GUI 导出为带若干 sheet 的 Excel 报表（明细、基础统计、老师分布、分类分布、周次分布）。

- `requirements.txt`
	- 功能：列出了运行所需的 Python 包（pandas、openpyxl、pdfplumber、pyyaml）。

- `src/__init__.py`
	- 功能：包初始化，占位（当前为无逻辑）。

- `src/file_parser.py`
	- 功能：非 GUI 的文件解析实现，包含 `get_file_list`、`parse_excel`、`parse_pdf`、`parse_files`。用于递归扫描文件夹并分别解析 Excel 与文本型 PDF。

- `src/data_cleaner.py`
	- 功能：对解析得到的课程记录进行清洗和去重，标准化课程名、讲师名和课时字段，最后返回清洗后的列表。

- `src/stat_export.py`
	- 功能：对清洗后的课程数据做统计并导出为 Excel（路径读取自 `config.yaml`），包含总体统计与明细导出。

---

## 工具实现的功能点（总结）

- 支持批量解析 Excel 与结构化表格型 PDF（表格抽取后按行处理）。
- 使用 `config.yaml` 的 `field_mapping` 对不同表头做动态映射，提升了兼容性。
- 提供 GUI 和命令行两种使用方式（GUI 更友好，命令行适合集成到自动化脚本）。
- 清洗流程做了基本去重（课程名+教师+分类）和课时标准化。
- 提供了较完整的导出逻辑，输出包括明细与多张统计表，方便后续分析。

---

## 已发现的缺陷与改进建议（优先级/说明）

1) 配置和路径
	 - 问题：`run.py` 中 `INPUT_FOLDER` 为硬编码示例，非交互式。`gui_run.py` 默认读取 `config.yaml`，但没有处理 config 文件不存在或路径不在当前目录的情况。
	 - 建议：增加命令行参数或配置加载的容错（如尝试从脚本目录、环境变量或在 GUI 中允许选择配置文件），并在缺失时给出明确提示。

2) 文件解析鲁棒性（优先）
	 - 问题：PDF 解析主要依赖 `pdfplumber.extract_tables()` 和若干正则，面对扫描 PDF（图片）或复杂布局（表格碎片、合并单元格）时易失败或错位。Excel 解析假设表头在每个 sheet 首行并能通过部分列名匹配到字段，但一些表格列名可能更复杂。
	 - 建议：
		 - 对扫描型 PDF 支持添加 OCR 备用方案（例如 pytesseract + pdf2image），作为可选依赖并在 requirements 中注明。仅在需要时启用。
		 - 在 Excel 解析中，对匹配不到字段的 sheet 做详细日志并跳过，或允许用户在 GUI 中手动映射列。

3) 错误处理与日志（中优先）
	 - 问题：部分解析函数只是 print 或返回简短错误信息，缺少集中化的日志记录（文件日志/级别）与异常上下文。
	 - 建议：引入 `logging` 模块，设置文件与控制台日志，区分 INFO/WARNING/ERROR，并在 GUI 日志区显示可读的异常摘要。

4) 去重与标注逻辑（中优先）
	 - 问题：去重策略在不同文件实现细节不完全一致（GUI 的 `clean_courses` 与 `src/data_cleaner.py` 逻辑略有差异），并且唯一键仅用课程名+教师+分类，可能把不同学期或不同地点的课程误判为重复。
	 - 建议：统一去重逻辑（在 `src` 中实现并由 GUI 调用），并将唯一键扩展为可配置（例如加入学期/周次/地点的选项）。同时保留去重时来源文件信息以便溯源。

5) 单元格文本解析（低优先）
	 - 问题：正则用于匹配课程名、周次、老师、地点的规则较脆弱，遇到带特殊符号或多语种内容会提取失败或截断不完整名称。
	 - 建议：逐步完善正则规则集，或者在 GUI 中提供“纠错”功能，让用户在解析结果中手动修正少数不正确的条目并重新统计。

6) 国际化与编码（低优先）
	 - 问题：代码中大量中文字符串用于列名与消息，若部署在非中文环境可能影响可读性；同时文件读取假设 `utf-8`，部分 Excel / PDF 可能存在其他编码或字体问题。
	 - 建议：抽离提示文本到资源文件以便国际化，同时在读取文本前做编码检测或增加配置项。

7) 单元测试与 CI（建议）
	 - 问题：项目没有自动化测试用例，修改解析或去重规则时容易产生回归。
	 - 建议：添加若干单元测试（针对解析示例片段的文本、Excel sheet 结构与 PDF 表格抽取），并配置一个简单的 CI（例如 GitHub Actions）在 PR 时运行测试与 lint。

8) 依赖与版本控制（说明）
	 - 问题：`requirements.txt` 中有包版本下限但未锁定精确版本，长期运行可能遇到不兼容变更。
	 - 建议：可使用 `pip freeze` 生成 `requirements-lock.txt` 或将项目迁移到 Poetry / Pipenv 以更好管理依赖；对于可选的 OCR 功能，单独说明并用 extras_require 或额外说明文档。

---

## 快速操作建议（对开发者）

- 若要运行 GUI：在项目根（包含 `config.yaml`）下运行 `python gui_run.py`。
- 若要批量处理目录：编辑 `run.py` 中 `INPUT_FOLDER` 为目标目录，然后运行 `python run.py`（建议改为通过命令行参数传入）。
- 若需调试单个文件解析，建议在 `src/file_parser.py` 中添加临时 `print` 或日志，并保存示例文件以便复现问题。

---

如果你希望我把 README 内容写到 `course_stat_tool/README.md`（而不是当前的 `app/READ.md`），我可以把它移动并建立为项目局部 README。接下来我会把 todo 中的“生成 README 内容”标记为已完成并进入“保存并验证”步骤（可选执行脚本运行检查）。

